version: '3.8'

services:
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  app:
    build: .
    ports:
      - "8765:8765"
    environment:
      - BROKER_URL=redis://redis:6379
      - SMTP_HOST=${SMTP_HOST:-0.0.0.0}
      - SMTP_PORT=${SMTP_PORT:-25}
      - WEBHOOK_SECRET=${WEBHOOK_SECRET}
      - FORWARD_FOR=${FORWARD_FOR}
      - PYTHONPATH=/app
    depends_on:
      redis:
        condition: service_healthy
    command: gunicorn --bind 0.0.0.0:8765 --workers 4 --timeout 600 --access-logfile - mailgun.app:app

  worker:
    build: .
    environment:
      - BROKER_URL=redis://redis:6379
      - SMTP_HOST=${SMTP_HOST:-0.0.0.0}
      - SMTP_PORT=${SMTP_PORT:-25}
      - FORWARD_FOR=${FORWARD_FOR}
      - PYTHONPATH=/app
    depends_on:
      redis:
        condition: service_healthy
    command: celery -A mailgun.celery_tasks.celery worker --loglevel=info
